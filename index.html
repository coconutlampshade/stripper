<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Stripper App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #f4f4f4;
            border-radius: 5px;
        }
        h1 {
            color: #333;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }
        .rich-text-editor {
            width: 100%;
            min-height: 200px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            overflow-y: auto;
        }
        .rich-text-editor:focus {
            outline: none;
            border-color: #28a745;
        }
        button {
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

<h1>Scheduled Post Stripper</h1>
<p>Instructions:</p>
<ol>
    <li>Go to the scheduled post in WordPress</li>
    <li>Click "Preview" to open the post preview</li>
    <li>Select all content (Ctrl+A or Cmd+A)</li>
    <li>Copy the content (Ctrl+C or Cmd+C)</li>
    <li>Paste it into the box below</li>
</ol>
<div id="contentInput" class="rich-text-editor" contenteditable="true" placeholder="Paste your content here..."></div>
<button onclick="processContent()">Strip Content</button>

<div id="output"></div>

<script>
    async function processContent() {
        const content = document.getElementById('contentInput').innerHTML;
        console.log('Processing content...');

        try {
            // Create a new DOM parser
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');

            // Remove all ad-related content
            const adSelectors = [
                '.ad_pushdown',
                '.boing-primis-video-in-article-content',
                '.boing-single-post-rev-content',
                '.boing-body-top-for-gumgum',
                '.boing-highlight-wrapper',
                'div[data-freestar-ad]',
                'div[data-google-query-id]',
                'div[data-rc-widget]',
                'div[data-widget-host="habitat"]',
                'div[data-title*="Placement name"]',
                'div[data-title*="Ads"]',
                'div[style*="border: 3px solid #ff0000"]',
                'div[style*="border:3px solid #ff0000"]',
                '.red-box',
                '.fs-pushdown',
                '.rc-widget',
                '.next-post-list-container',
                '.share-comments-container',
                '.tags-list'
            ];
            
            adSelectors.forEach(selector => {
                const elements = doc.querySelectorAll(selector);
                elements.forEach(el => el.remove());
            });

            // Convert featured images to figure elements
            const featuredImages = doc.querySelectorAll('.featured-image');
            featuredImages.forEach(featuredImage => {
                const img = featuredImage.querySelector('img');
                const caption = featuredImage.querySelector('.caption');
                
                if (img) {
                    const figure = document.createElement('figure');
                    const newImg = document.createElement('img');
                    const figcaption = document.createElement('figcaption');
                    
                    // Set image attributes
                    newImg.width = 600;
                    newImg.src = img.src.split('?')[0]; // Remove query parameters
                    
                    // Set caption text if exists
                    if (caption) {
                        figcaption.textContent = caption.textContent;
                    }
                    
                    // Build the figure element
                    figure.appendChild(newImg);
                    figure.appendChild(figcaption);
                    
                    // Replace the original div with the new figure
                    featuredImage.replaceWith(figure);
                }
            });

            // Find the h1 tag
            const h1 = doc.querySelector('h1');
            if (h1) {
                // Find the article element that contains the h1
                const article = h1.closest('article');
                if (article) {
                    // Create a new document fragment
                    const fragment = document.createDocumentFragment();
                    
                    // Move the entire article content into the fragment
                    while (article.firstChild) {
                        fragment.appendChild(article.firstChild);
                    }
                    
                    // Clear the body and append the fragment
                    doc.body.innerHTML = '';
                    doc.body.appendChild(fragment);
                } else {
                    // If no article element found, just keep content from h1 onwards
                    const fragment = document.createDocumentFragment();
                    let currentNode = h1;
                    
                    while (currentNode) {
                        const nextNode = currentNode.nextSibling;
                        fragment.appendChild(currentNode);
                        currentNode = nextNode;
                    }
                    
                    doc.body.innerHTML = '';
                    doc.body.appendChild(fragment);
                }
            }

            // Get the cleaned HTML content
            const cleanedContent = doc.body.innerHTML;

            // Display the processed content
            document.getElementById('output').innerHTML = `
                <h2>Processed Content:</h2>
                <p>Cleaned content has been copied to clipboard.</p>
                <button onclick="openSubstack()">Open Substack New Post Page</button>
                <button onclick="inspectHTML()">Inspect HTML</button>
                <p>After clicking the "Open Substack" button above, please paste the content (Ctrl+V or Cmd+V) into the "Start writing..." area in the new tab.</p>
                <br><br>
                <h3>Cleaned Content:</h3>
                <div id="cleanedContentDisplay" contenteditable="true">${cleanedContent}</div>
            `;

            // Copy rich text content to clipboard
            const range = document.createRange();
            range.selectNode(document.getElementById('cleanedContentDisplay'));
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            selection.removeAllRanges();
        } catch (error) {
            console.error('Error processing content:', error);
            document.getElementById('output').innerHTML = 'Error: ' + error.message;
        }
    }

    function openSubstack() {
        window.open('https://boingboing.substack.com/publish/post/', '_blank');
    }

    function inspectHTML() {
        const cleanedContent = document.getElementById('cleanedContentDisplay').innerHTML;
        const escapedHTML = cleanedContent
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        
        const htmlDisplay = `
            <h2>HTML Source:</h2>
            <button onclick="document.getElementById('output').innerHTML = document.getElementById('originalContent').innerHTML;">Back to Cleaned Content</button>
            <pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f4f4f4; padding: 10px; border: 1px solid #ddd;">
                <code>${escapedHTML}</code>
            </pre>
        `;
        
        // Store the original content
        const originalContent = document.getElementById('output').innerHTML;
        document.getElementById('output').innerHTML = `
            <div id="originalContent" style="display:none;">${originalContent}</div>
            ${htmlDisplay}
        `;
    }

    // Add new method to handle embeds
    function handleEmbeds(mainContent) {
        // Replace <figure> elements with YouTube link
        const youtubeEmbeds = mainContent.querySelectorAll('figure.wp-block-embed.is-type-video.is-provider-youtube');
        youtubeEmbeds.forEach(figure => {
            const iframe = figure.querySelector('iframe');
            if (iframe) {
                const src = iframe.src;
                const videoId = src.split('/embed/')[1].split('?')[0];
                const newParagraph = document.createElement('p');
                newParagraph.textContent = `https://www.youtube.com/watch?v=${videoId}`;
                figure.replaceWith(newParagraph);
            }
        });

        // Replace TikTok embeds with direct link
        const tiktokEmbeds = mainContent.querySelectorAll('figure.wp-block-embed.is-provider-tiktok');
        tiktokEmbeds.forEach(figure => {
            const blockquote = figure.querySelector('blockquote.tiktok-embed');
            if (blockquote) {
                const cite = blockquote.getAttribute('cite');
                if (cite) {
                    const newParagraph = document.createElement('p');
                    newParagraph.textContent = cite;
                    figure.replaceWith(newParagraph);
                }
            }
        });

        // Replace Instagram embeds with direct link
        const instagramEmbeds = mainContent.querySelectorAll('figure.wp-block-embed.is-provider-instagram');
        instagramEmbeds.forEach(figure => {
            const blockquote = figure.querySelector('blockquote.instagram-media');
            if (blockquote) {
                const permalink = blockquote.getAttribute('data-instgrm-permalink');
                if (permalink) {
                    const newParagraph = document.createElement('p');
                    newParagraph.textContent = permalink.split('?')[0];
                    figure.replaceWith(newParagraph);
                }
            }
        });
    }
</script>

</body>
</html>
